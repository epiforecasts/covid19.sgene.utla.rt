---
title: "Population-level association between S-gene target failure and the relationship between cases, hospitalisations and deaths of Covid-19"
subtitle: "Work in progress - not peer reviewed"
author: Sam Abbott, Sebastian Funk on behalf of the CMMID Covid-19 Working Group
bibliography: references.bib
date: 12 January, 2021
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
header-includes:
   - \usepackage{float}
output:
    pdf_document
---

```{r setup, echo = FALSE, cache = FALSE, include = FALSE}
library(here)
library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(janitor)
library(kableExtra)
library(tibble)
library(brms)
library(bayesplot)
library(gt)
library(stringr)
library(purrr)
library(scales)

lagged_severity_data <- readRDS(here("data", "lagged_severity_data.rds"))
```

For correspondence: sebastian.funk@lshtm.ac.uk

# Aim

Explore the association between S-gene target failure and the relationship between test-positive cases, Covid-19 hospitalisations and Covid-19 deaths by Upper-tier Local Authority (UTLA) at the population level.

# Method

## Data

We used 4 main sources of data: test positive Covid-19 notifications by UTLA [@ukgov], hospitalisations with Covid-19 by UTLA [@covidnhsdata], deaths linked to Covid-19 notification within 28 days of notification [@ukgov], and S-gene status from PCR tests by local authority provided by Public Health England (PHE)[@phe]. We aggregated the data at the weekly level and restricted the analysis to the period beginning Monday, 5 October.

## Statistical analysis

We calculated the weekly proportion of positive tests that were S-gene negative over time by local authority and adjusted to date of infection from date of specimen by shifting all estimates back by a week. We estimated pairwise fixed lags between cases, admissions and deaths by maximising Pearson's correlation coefficient. We aggregated all data by week of infection.

We assumed that the observed number of Covid-19 admissions/deaths ($D_{i,t}$) within 28 days by date of infection were a function of Covid-19 notifications/admissions ($C_{i,t}$) by date of infection scaled by the case fatality rate of S-gene positive cases ($c^+$) and S-gene negative cases ($c^-$),

$$D_{i,t} \sim \mathrm{NB}\left(c^{+}\left(1-f_{it}\right)C_{i,t} + c^{-}f_{it}C_{i,t},  \phi \right)$$
where $i$ indicates UTLA, $t$ week of infection, and $f_{it}$ is the fraction of cases that were found to be S-gene negative by UTLA each week. The case fatality rate (or hospitalisation-fatality rate / case-hospitalisation rate, respectively) of S-gene negative cases then assumed was then assumed to be a function of static local variation, normalised Covid-19 notifications by date of infection, and residual temporal variation.

$$c^{+} = \mathrm{logit}^{-1}\left(\gamma_{i,t}\right)$$
where $\gamma_{i,t}$ is either a UTLA-level intercept $\gamma_{i,t}\equiv \delta_i$ corresponding to the baseline case fatality rate per UTLA, or a temporal intercept $\gamma_{i,t}\equiv \theta_t$ corresponding to the baseline case fatality rate over time, with each time point treated as independent. In other words, we stratify the data set either by UTLA or by week and determine whether differences in the associations between cases, admissions and deaths are explained by changes in proportion of cases that are SGTF over time and space, respectively.

The S-gene negative case fatality rate was then assumed to be related to the S-gene positive case fatality rate via a multiplicative relationship,

$$c^{-} = \alpha c^{+}$$

or an additive relationship

$$c^{-} = \alpha + c^{+}$$

where $\alpha$ represents either the multiplicative change in case fatality rate or the additive change. These alternative parameterisations represent either a population wide effect for the former parameterisation or a subpopulation effect in the latter parameterisation.

All models were implemented using the `brms` [@brms] package in `R`. All code required to reproduce this analysis is available from [https://github.com/epiforecasts/covid19.sgene.utla.rt/](https://github.com/epiforecasts/covid19.sgene.utla.rt/).

# Results


```{r region, echo=FALSE, fig.width=10, fig.height=10}
plot_severity <- function(df, geography = "utla", alpha = 0.2) {
  prop_data <- df %>% 
  filter(loc %in% geography) %>%
  mutate(data = map2(data, target, ~ mutate(.x, rate = deaths / cases, type = .y))) %>% 
  pull(data) %>% 
  bind_rows() %>% 
  mutate(type = case_when(type %in% "cfr" ~ "Case fatality rate",
                          type %in% "chr" ~ "Case hospitalisation rate",
                          type %in% "hfr" ~ "Hospitalisation fatality rate"))
  
  if (geography %in% "region") {
    prop_data <- prop_data %>% 
      mutate(region = loc)
  }
  
  suppressWarnings(ggplot(prop_data, aes(x = prop_sgtf, y = rate,
                      fill = region, size = samples)) +
  geom_jitter(pch = 21, alpha = alpha) +
  scale_fill_brewer("", palette = "Set1") +
  scale_y_continuous(labels = percent) +
  xlab("Proportion with S gene dropped") +
  ylab("Rate") +
  facet_wrap(~ type, scales = "free_y", nrow = 2) +
  theme_cowplot() +
  labs(size = paste("Samples")) +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        legend.box = "vertical"))
}
  
plot_severity(lagged_severity_data, geography = "region", alpha = 0.4)
```

*Figure 1: Proportion with S gene dropped compared to the adjusted severity rates each week beginning Monday the 5th of October. Each point represents one NHS region and one week, with the size given by the number of PCR tests.*


```{r utla, echo=FALSE, fig.width=10, fig.height=10}
plot_severity(lagged_severity_data, geography = "utla", alpha = 0.2)
```

*Figure 2: Proportion with S gene dropped compared to the adjusted severity rates each week beginning Monday the 5th of October. Each point represents one UTLA and one week, with the size given by the number of PCR tests.*




```{r effects-univariate, echo = FALSE, results = 'asis'}
effects <- readRDS(here("data", "severity_sgtf_effect.rds"))

make_effects_table <- function(effects, model) {
  effects %>%
  filter(models %in% "intercept") %>% 
  kbl() %>%
  kable_styling()
}

```
*Table 2: Parameter $\alpha$ with 95% credible intervals for the both additive and multiplicative assumptions across all models evaluated. In the additive model the effect can be interpreted as a direct change in the case-fatality rate related to S-gene negativity whilst in multiplicative model the effect can be interpreted as a scaling of the S-gene positive case-fatality rate.*


# Discussion

We studied the relationship between SGTF (as a proxy for the new variant of concern) and the association between Covid-19 cases, hospitalisations and deaths adjusted using both an additive and a multiplicative relationship. We considered space and time as confounders.

# References

<div id = 'refs'></div>

# Appendix: fits

```{r fit, echo = FALSE,fig.width = 10, fig.height = 10, eval = FALSE}
## calculate predicted intervals
plot_pred_int <- function(data, yrep, psis, quantiles = c(0.05, 0.25, 0.5, 0.75, 0.95)) {

  y <- data$deaths
  ## construct predicted quantiles
  pred_int <- suppressWarnings(E_loo(
    x = yrep,
    psis_object = psis,
    type = "quantile",
    probs = quantiles
  )$value) %>%
  t() %>%
  `colnames<-`(quantiles) %>%
  as_tibble() %>%
  bind_cols(y = y) %>%
  bind_cols(data) %>%
  arrange(`0.5`) %>%
  group_by(week_infection) %>%
  mutate(id = 1:n()) %>%
  ungroup()

  p <- ggplot(pred_int, aes(x = id, y = y)) +
    geom_point(size = 0.25) +
    geom_ribbon(aes(ymin = `0.25`, ymax = `0.75`), alpha = 0.3) +
    geom_ribbon(aes(ymin = `0.05`, ymax = `0.95`), alpha = 0.15) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    facet_wrap(. ~ week_infection, scales = "free_y") +
    xlab("Local area") +
    ylab("Deaths") +
    theme_cowplot() +
    theme(axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank())

  print(p)
}

p <- plot_pred_int(hfr$data, hfr$yrep[["all"]], hfr$psis[["all"]])
print(p)
```

